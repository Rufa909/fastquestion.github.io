<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Kết Quả Bài Làm</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <form id="danhsach">
      <h1>Kết Quả Làm Bài</h1>
      <table border="1" cellpadding="10">
        <thead>
          <tr>
            <th>Tên</th>
            <th>Bắt đầu</th>
            <th>Nộp bài</th>
            <th>Số câu đúng</th>
            <th>Tổng câu</th>
            <th>Xem lại</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
      <div class="back" style="margin-top: 20px">
        <a href="index.html" style="color: black; cursor: pointer">Trở về</a>
      </div>
    </form>

    <script>
      const ALLOW_START_HOUR = 13;
      const ALLOW_START_MINUTE_START = 0;
      const ALLOW_START_MINUTE_END = 53;

      let isDuringExam = false;

      async function checkTimeAndLoadResults() {
        try {
          const res = await fetch("https://demotestexam.glitch.me/api/time");
          const data = await res.json();
          const serverDate = new Date(data.currentTime);

          const vietnamTime = new Date(
            serverDate.toLocaleString("en-US", { timeZone: "Asia/Ho_Chi_Minh" })
          );
          const hour = vietnamTime.getHours();
          const minute = vietnamTime.getMinutes();

          isDuringExam =
            hour === ALLOW_START_HOUR &&
            minute >= ALLOW_START_MINUTE_START &&
            minute <= ALLOW_START_MINUTE_END;

          loadResults();
        } catch (error) {
          console.error("Lỗi khi lấy thời gian từ server:", error);
        }
      }

      function loadResults() {
        const correctAnswers = {
          q1: "C",
          q2: "D",
          q3: "B",
          q4: "A",
          q5: "A",
          q6: "B",
          q7: "C",
          q8: "A",
          q9: "A",
          q10: "D",
          q11: "C",
          q12: "D",
          q13: "D",
          q14: "C",
          q15: "C",
        };

        fetch("/users")
          .then((res) => res.json())
          .then((users) => {
            const totalQuestions = Object.keys(correctAnswers).length;

            users.forEach((user) => {
              let correct = 0;
              for (const [key, value] of Object.entries(user.answers)) {
                if (correctAnswers[key] === value) correct++;
              }

              const reviewContent = isDuringExam
                ? "Chưa có kết quả"
                : `<a href="xemlaidiem.html?username=${user.username}">Xem</a>`;

              const row = document.createElement("tr");
              row.innerHTML = `
            <td>${user.username}</td>
            <td>${new Date(user.startedAt).toLocaleString()}</td>
            <td>${new Date(user.submittedAt).toLocaleString()}</td>
            <td>${correct}</td>
            <td>${totalQuestions}</td>
            <td>${reviewContent}</td>
          `;

              document.getElementById("resultsTable").appendChild(row);
            });
          })
          .catch((error) => {
            console.error("Lỗi khi tải kết quả:", error);
          });
      }

      window.onload = checkTimeAndLoadResults;
    </script>
  </body>
</html>
